(function($){var j;var k=$.Sequence=function(){this.master=$.Deferred();this.last=$.Deferred().resolve();this.returnVals=[];this.fxns={}};k.CB=new Object();k.PREV=new Object();k.ERR=new Object();k.prototype.wait=function(b){var c=this.last,def=this.last=$.Deferred();c.then(function(){var a=$.makeArray(arguments);setTimeout(function(){def.resolve.apply(def,a)},b)},function(){def.reject.apply(def,arguments)});return this};k.prototype.handle=function(a,b,c){var d=_parms(arguments);this.last=_ex(this.returnVals,this.master,this.last,_wrapFx(d.fx,d.opts,true),d.scope,d.args);return this};k.prototype.run=function(a,b){var c=$.makeArray(arguments);a=(typeof(c[0])==='object')?c.shift():null;b=c.shift();if(!(b in this.fxns)){throw new Error('invalid function name "'+b+'" (did you forget to call register?)');}this.last=_ex(this.returnVals,this.master,this.last,this.fxns[b],a,c);return this};k.prototype.register=function(a,b,c){c=c||{};if(a in this.fxns&&typeof(console)==='object'&&console.warn){console.warn('Method '+a+' already exists; it will now be overwritten')}this.fxns[a]=_wrapFx(b,c,('cbPos'in c));return this};k.prototype.wrap=function(a,b,c){var d=_parms(arguments);this.last=_ex(this.returnVals,this.master,this.last,_wrapFx(d.fx,d.opts),d.scope,d.args);return this};k.prototype.then=function(a,b){this.last.then(_catch(a),_catch(b));return this};k.prototype.end=function(){var a=this.returnVals,master=this.master;this.last.then(function(){master.resolve(a)},function(){master.reject(a)});return master.promise()};k.start=function(){return new k()};function _parms(a){var b=$.makeArray(a),out={opts:{},scope:null},pos=0;while(b.length&&pos++<3){if($.isFunction(b[0])){out.fx=b.shift();break}else if($.isPlainObject(b[0])){out.opts=$.extend({},b.shift())}else if(typeof(b[0])==='object'){out.scope=b.shift()}else{throw new Error('Invalid argument '+b[0]+' at pos '+pos);}}if(!('fx'in out)){throw new Error('Function to call was not included in arguments');}out.args=b;return out}function _ex(a,b,c,d,e,f){var g=$.Deferred();if(b.isResolved()||b.isRejected()){throw new Error('Cannot execute additional steps on a sequence after end() has been called :(');}if(c.isRejected()){g=c}else{c.then(function(){d(g,e,f,_result(arguments))},function(){g.reject.apply(g,arguments)});g.always(function(){if(!c.isRejected()){a.push(_result(arguments))}})}return g}function _wrapFx(f,g,h){if(typeof(g)==='boolean'){h=g;g={}}g=g||{};return function(a,b,c,d){try{var v=f.apply(b,_fxArgs(a,g,c,d,h));if(!h){if(_isDeferred(v)){v.then(function(){a.resolve.apply(a,arguments)},function(){a.reject.apply(a,arguments)})}else if(v instanceof Error){a.reject(v)}else{a.resolve(v)}}}catch(e){a.reject(e)}}}function _fxArgs(a,b,c,e,f){var i,d,out=$.makeArray(c);b=b||{};if(f){_fillPlaceholder(out,k.CB,b.cbPos,b.cbKey,_cb(a),0);_fillPlaceholder(out,k.ERR,b.errPos,b.errKey,_errCb(a))}_fillPlaceholder(out,k.PREV,b.prevPos,b.prevKey,e);if('defaults'in b){d=b.defaults;i=d.length;while(i--){if(!_exists(out[i])){out[i]=d[i]}else if(typeof(d[i])==='object'&&typeof(out[i])==='object'){out[i]=$.extend(true,{},d[i],out[i])}}}return out}function _cb(a){return function(v){if(v instanceof Error){a.reject.apply(a,arguments)}else{a.resolve.apply(a,arguments)}}}function _errCb(a){return function(){a.reject.apply(a,arguments)}}function _fillPlaceholder(a,b,c,d,e,f){var i,replaceLength=0,hasPos=_exists(c),hasKey=_exists(d);if(hasPos){i=c}else{d='placeholder';i=a.length;while(i--){if(a[i]===b){replaceLength=1;break}}if(i<0&&typeof(f)=='number'){i=f}}if(i>=0){if(hasPos&&hasKey){if(!_exists(a[i])){a[i]=typeof(d)==='string'?{}:[]}a[i][d]=e}else{a.splice(i,replaceLength,e)}}}function _catch(a){if(!a){return j}return function(){try{a.apply(null,arguments)}catch(e){if(typeof(console)==='object'&&typeof(console.error)==='function'){console.error(e)}}}}function _result(a){if(a.length>1){return $.makeArray(a)}return a[0]}function _exists(a){return a!==j&&a!==null}function _isDeferred(o){return typeof(o)==='object'&&('then'in o)&&('always'in o)&&('fail'in o)}})(jQuery);