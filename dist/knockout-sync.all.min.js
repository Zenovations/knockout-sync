/*! Knockout Sync - v0.1.0 - 2012-07-02
* https://github.com/katowulf/knockout-sync
* Copyright (c) 2012 Michael "Kato" Wulf; Licensed MIT, GPL */
(function(a){function d(b){var c=a.makeArray(b),d={opts:{},scope:null},e=0;while(c.length&&e++<3){if(a.isFunction(c[0])){d.fx=c.shift();break}if(a.isPlainObject(c[0]))d.opts=a.extend({},c.shift());else if(typeof c[0]=="object")d.scope=c.shift();else if(c[0]!==null)throw new Error("Invalid argument "+c[0]+" at pos "+e)}if("fx"in d)return d.args=c,d;throw new Error("Function to call was not included in arguments")}function e(a,b,c){var e=-1,f=c.length,h,i,j,k=0;l:while(++e<f&&e<3)switch(typeof c[e]){case"string":h=c[e];if(!(h in b))throw new Error("Invalid function name "+h);c[e]=b[h],j=!0;break l;case"function":j=!1;break l;default:}return i=d(c),i.wait=k,j||(i.fx=g(a,i.fx,i.opts,s(i))),i}function f(b,c,d,e,g,i,j){var k=a.Deferred();if(c.isResolved()||c.isRejected())throw new Error("Cannot execute additional steps on a sequence after end() has been called :(");return d.isRejected()?k=d:j.abortEvent?k.reject(j.abortEvent):j.pauseEvent?f(b,c,d,e,g,i,j).then(function(){h(k,j,a.makeArray(arguments))},function(){k.reject.apply(k,a.makeArray(arguments))}):(d.then(function(){e(k,g,i,n(arguments))},function(){k.reject.apply(k,arguments)}),k.always(function(){d.isRejected()||b.push(n(arguments))})),k}function g(b,c,d,e){return function(f,g,j,k){try{var m=c.apply(g,i(j,l(b,d,f,e,k)));e||(p(m)?m.then(function(){h(f,b,a.makeArray(arguments))},function(){f.reject.apply(f,arguments)}):m instanceof Error?f.reject(m):h(f,b,[m]))}catch(n){f.reject(n)}}}function h(a,b,c){b.abortEvent?a.reject(b.abortEvent):b.pauseEvent?b.pauseEvent.then(function(){a.resolve.apply(a,c)},function(b){a.reject(b)}):a.resolve.apply(a,c)}function i(b,c){var d,e,f=a.makeArray(b);t.fill(f,c);if("defaults"in c.opts){e=c.opts.defaults,d=e.length;while(d--)o(f[d])?typeof e[d]=="object"&&typeof f[d]=="object"&&(f[d]=a.extend(!0,{},e[d],f[d])):f[d]=e[d]}return f}function j(b,c){return function(d){d instanceof Error?b.reject.apply(b,arguments):h(b,c,a.makeArray(arguments))}}function k(a){return function(){a.reject.apply(a,arguments)}}function l(b,c,d,e,f){return{shared:b,opts:a.extend({},c),prev:f,def:d,placeholders:e?["cb","err","prev"]:["prev"]}}function m(c){return c?function(){try{c.apply(null,a.makeArray(arguments))}catch(b){var d=typeof window.console=="object"?window.console:{error:function(){}};d.error(b)}}:b}function n(b){return b.length>1?a.makeArray(b):b[0]}function o(a){return a!==b&&a!==null&&a!==""}function p(a){return typeof a=="object"&&"then"in a&&"always"in a&&"fail"in a}function q(b,c){var d,e,f;if(c&&a.isPlainObject(c))for(d in c)if(c.hasOwnProperty(d)){f=c[d];switch(typeof f){case"function":e=null;break;case"object":e=f,f=e.fxn||e.fx,delete e.fxn;break;default:throw new Error("each element of hash passed into start() must be an object or function")}b.register(d,f,e)}}function r(b,c,d,e){var f=a.Deferred();return b.opts.wait>0?setTimeout(function(){b.fx(f,b.scope,b.args,d)},b.opts.wait):b.fx(f,b.scope,b.args,d),f.done(function(){e.vals[c]=n(arguments),++e.done==e.max&&e.masterDef.resolve(e.vals)}).fail(function(a){e.masterDef.reject(a)}),f.promise()}function s(a){if("cbPos"in a.opts)return!0;var b=a.args,d=b.length;while(d--)if(b[d]===c.CB)return!0;return!1}function u(b){var c=(new Date).getTime(),d=a.Deferred();return setTimeout(function(){var a=(new Date).getTime()-c;if(a<b)var e=setInterval(function(){(new Date).getTime()-c>=b&&(clearInterval(e),d.resolve(!0))},a);else d.resolve(!0)},b),d.promise()}function v(a,b,c){var d=a.slice((c||b)+1||a.length);return a.length=b<0?a.length+b:b,a.push.apply(a,d)}var b,c=a.Sequence=function(){this.master=a.Deferred(),this.returnVals=[],this.fxns={},this.last=a.Deferred().resolve(this),this.shared={pauseEvent:!1,abortEvent:!1,lastIf:b},this.fxns.wait=g(this.shared,function(b,c){var d=a.Deferred();return u(b).then(function(){d.resolve(c)}),d},{prevPos:1})};c.CB=new Object,c.PREV=new Object,c.ERR=new Object,c.start=function(a){var b=new c;return a&&q(b,a),b},c.prototype.wait=function(b){var c=this.last,d=this.last=a.Deferred(),e=this.shared;return c.then(function(){var c=a.makeArray(arguments);u(b).then(function(){h(d,e,c)})},function(){d.reject.apply(d,n(arguments))}),this},c.prototype.handle=function(a,b,c){var e=d(arguments);return this.last=f(this.returnVals,this.master,this.last,g(this.shared,e.fx,e.opts,!0),e.scope,e.args,this.shared),this},c.prototype.run=function(b,c){var d=a.makeArray(arguments);b=typeof d[0]=="object"?d.shift():null,c=d.shift();if(c in this.fxns)return this.last=f(this.returnVals,this.master,this.last,this.fxns[c],b,d,this.shared),this;throw new Error('invalid function name "'+c+'" (did you forget to call register?)')},a.Sequence.prototype._=a.Sequence.prototype.run,c.prototype.register=function(b,c,d){d=a.extend({},d);if(b in this)throw new Error(b+" already exists in Sequence, it cannot be overwritten by register() :(");return this[b]=function(){return this.run.apply(this,[b].concat(a.makeArray(arguments)))},this.fxns[b]=g(this.shared,c,d,"cbPos"in d),this},c.prototype.wrap=function(a,b,c){var e=d(arguments);return this.last=f(this.returnVals,this.master,this.last,g(this.shared,e.fx,e.opts,!1),e.scope,e.args,this.shared),this},c.prototype.then=function(a,b){return this.last.then(m(a),m(b)),this},c.prototype.parallel=function(b){var d=this;return this.wrap(function(c){var f=b.length,g={vals:[],done:0,max:b.length,masterDef:a.Deferred()};while(f--)r(e(d.shared,d.fxns,b[f]),f,c,g);return g.masterDef.promise()},c.PREV)},c.prototype.if=function(b,d,f){var g=a.makeArray(arguments),h=this.fxns,i=this.shared;return b=g.shift(),this.wrap(function(c){i.lastIf=b(c,i.lastIf);if(i.lastIf){var d=e(i,h,g),f=a.Deferred();return d.fx(f,d.scope,d.args,c),f.promise()}return c},c.PREV)},c.prototype.end=function(a){var b=this.returnVals,c=this.master;return this.last.then(function(){c.resolve(b)},function(){if(a)throw n(arguments);c.reject.call(c,n(arguments))}),c.promise()},c.prototype.pause=function(){return this.shared.pauseEvent=a.Deferred(),this},c.prototype.unpause=function(){var a=this.shared.pauseEvent;return a&&a.resolve(),this},c.prototype.abort=function(a){var b=this.shared.abortEvent=new Error(a||"Sequence aborted");return b.sequenceAborted=!0,this.shared.pauseEvent&&this.shared.pauseEvent.reject(b),this};var t={};(function(a){function b(b,c,d){var e,f=g(d),i=h(d),j=d+"Pos",k=d+"Key",l={prefix:d,pos:-1,key:a,fromPlaceholder:!1},m=j in c&&c[j]>=0,n=k in c&&typeof c[k]in{number:1,string:1};if(m)l.pos=c[j],n&&(l.key=c[k]);else{e=b.length;while(e--)if(b[e]===f){l.pos=e,l.fromPlaceholder=!0;break}e<0&&typeof i=="number"&&(l.pos=i)}return l}function d(a,b){return a.pos-b.pos}function e(a){return typeof a=="number"?[]:{}}function f(b,c){var d=c.key!==a,f=b.length<c.pos+1;d?(f&&(b[c.pos]=e(c.key)),b[c.pos][c.key]=c.val):f?b[c.pos]=c.val:b.splice(c.pos,0,c.val)}function g(a){switch(a){case"cb":return c.CB;case"err":return c.ERR;case"prev":return c.PREV;default:throw new Error("Invalid placeholder type (must be one of cb/err/prev): "+a)}}function h(a){switch(a){case"cb":return 0;case"err":return!1;case"prev":return!1;default:throw new Error("Invalid placeholder type (must be one of cb/err/prev): "+a)}}function i(a,b){switch(a){case"cb":return j(b.def,b.shared);case"err":return k(b.def);case"prev":return b.prev;default:throw new Error("Invalid placeholder type (must be one of cb/err/prev): "+a)}}t.fill=function(a,c){var e,g,h,j=c.placeholders,k=j.length,l=[],m=[];while(k--)g=j[k],e=b(a,c.opts,g),e.pos>-1&&(e.val=i(g,c),e.fromPlaceholder&&m.push(e)||l.push(e));m.sort(d),l.sort(d),h=m.length;for(k=0;k<h;k++)e=m[k],a[e.pos]=e.val;h=l.length;for(k=0;k<h;k++)f(a,l[k])}})()})(jQuery),function(a,b){function c(b,c){var d=a.Deferred(),f=e(arguments);try{var g=f.fx.apply(f.scope,f.args);return g instanceof Error?d.reject(g).promise():h(g)?g:d.resolve(g).promise()}catch(i){return d.reject(i).promise()}}function d(b,c){var d=a.Deferred(),f=e(arguments,!0,d);b||(b=null);try{f.fx.apply(f.scope,f.args)}catch(g){d.reject(g)}return d.promise()}function e(a,b,c){var d=g(a),e,h=null,i=0;while(d.length&&!e&&i++<2)typeof d[0]=="function"?e=d.shift():h=d.shift()||null;if(!e)throw new Error("first two arguments to handle() and when() must be either a scope object or the function to run");return b&&f(d,c),{fx:e,scope:h,args:d}}function f(a,b){var c=-1,e,f=a.length,g=!1;if(f){while(++c<f)e=a[c],e===d.CALLBACK?(g=!0,a[c]=i(b)):e===d.ERRBACK&&(a[c]=j(b));g||a.unshift(i(b))}else a[0]=i(b),a[1]=j(b)}function g(a){return Array.prototype.slice.call(a)}function h(a){return a!==null&&typeof a=="object"&&typeof a.then=="function"&&typeof a.always=="function"}function i(a){return function(b){b instanceof Error?a.reject.apply(a,arguments):a.resolve.apply(a,arguments)}}function j(a){return function(){a.reject.apply(a,arguments)}}b.extenders.sync=function(a,c){return a.crud={isDirty:b.observable(c)},a.subscribe(function(b){a.crud.isDirty(!0)}),a},b.sync||(b.sync={}),b.sync.stores||(b.sync.stores=[]),b.sync.use=function(){},b.sync.newList=function(){},b.sync.newRecord=function(){},d.CALLBACK=new Object,d.ERRBACK=new Object,b.sync||(b.sync={}),b.sync.when=c,b.sync.handle=d}(jQuery,ko),function(a){function b(b){var d=a.utils.extend({type:"string",required:!1,persist:!0,observe:!0,minLength:0,maxLength:0,valid:null,format:function(a){return a}},b.defaults);this.store=b.dataStore,this.table=b.dataTable,this.key=b.primaryKey,this.sort=b.priorityField,this.validator=b.validator,this.fields=c(d,b.fields),this.recordFactory=new e(this)}function c(b,c){var e=[],f;for(var g in c)c.hasOwnProperty(g)&&(f=a.utils.extend(b,c[g]),d(f),e.push(f));return e}function d(a){if(!a.hasOwnProperty("default")||!a.default)switch(a.type){case"boolean":a.default=!1;break;case"int":case"float":case"date":a.default=0;break;case"string":case"email":default:a.default=null}}function e(a){}function f(){}a.sync||(a.sync={}),b.prototype.new=function(a){},e.create=function(a){},f.prototype.hasKey=function(){},f.prototype.getKey=function(){}}(ko),function(a){function c(a,b){this.base=(new Firebase(a)).child(b)}function d(a,b){return b?a.child(b):a.push()}function e(a,c){var d=a&&c&&a.hasOwnProperty(c)?a[c]:b;return d!==null&&d!==b}function f(a,b){var c,d={};for(c in a)a.hasOwnProperty(c)&&(d[c]=h(a[c].type,b,c));return d}function g(a){switch(a){case"boolean":return!1;case"int":return 0;case"float":return 0;case"string":case"email":case"date":return null;default:throw new Error("Invaild field type "+a)}}function h(a,b,c){if(!e(b,c))return g(a);var d=b[c];switch(a){case"boolean":return d?!0:!1;case"int":return d=parseInt(d),isNaN(d)?g(a):d;case"float":return d=parseFloat(d),isNaN(d)?g(a):d;case"date":return i(d);case"string":case"email":return d+"";default:throw new Error("Invaild field type "+a)}}function i(a){if(typeof a=="object"){if(a.toISOString)return a.toISOString();if(typeof moment=="object"&&moment.isMoment&&moment.isMoment(a))return moment.defaultFormat()}return g("date")}function j(a){return typeof a=="object"&&a.getKey?a.getKey():a}var b;c.RECORD_ID=new Object,c.prototype.create=function(c,e){return a.sync.handle(this,function(a,g){var h=this.base.child(c.dataTable),i=e.hasKey()?e.getKey():b,j=d(h,i);j.set(f(c.fields,e.getData()),function(b){b&&a(j.name())||g(j.name())})})},c.prototype.read=function(b,c){return a.sync.handle(this,function(a){var e=this.base.child(b.dataTable),f=j(c),g=d(e,f);g.once("value",function(b){a(b.val())})})},c.prototype.update=function(a,b){},c.prototype.delete=function(a,b){},c.prototype.query=function(a,b){},c.prototype.sync=function(a){},c.prototype.onDisconnect=function(a){},c.prototype.onConnect=function(a){},Date.prototype.toISOString||(Date.prototype.toISOString=function(){function a(a){return a<10?"0"+a:a}return this.getUTCFullYear()+"-"+a(this.getUTCMonth()+1)+"-"+a(this.getUTCDate())+"T"+a(this.getUTCHours())+":"+a(this.getUTCMinutes())+":"+a(this.getUTCSeconds())+"Z"}),a.sync||(a.sync={stores:[]}),a.sync.stores.FirebaseStore=c}(ko);